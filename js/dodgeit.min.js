window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}()),Math.randomRange=function(a,b,c){var d=Math.random()*(b-a)+a;return c&&(d=Math.floor(d)),d},Math.randomWeighted=function(a){for(var b=a.reduce(function(a,b){return a+b},0),c=Math.randomRange(0,b),d=0,e=0;e<=a.length-1;e++)if(d+=a[e],d>c)return e},$(function(){var a=function(){var a=!1,b=function(){a=!1;var b=localStorage.getItem("options");try{b=JSON.parse(b)}catch(c){return}$.extend(!0,d,b),a=!0},c=function(){a&&localStorage.setItem("options",JSON.stringify(d))},d={name:"Unknown",style:"car",speed:300,music:{mute:!1,volume:.5},sfx:{mute:!1,volume:.5},controls:{up:{device:"keyboard",type:null,code:38},down:{device:"keyboard",type:null,code:40},left:{device:"keyboard",type:null,code:37},right:{device:"keyboard",type:null,code:39},enter:{device:"keyboard",type:null,code:13},back:{device:"keyboard",type:null,code:8}},gamepad:{axes_selected:0}},e=$("div#game");return e.children().hide(),b(),{container:e,options:d,load:b,save:c}}(),b={music:function(){var b=["music/01_A_Night_Of_Dizzy_Spells.mp3","music/02_Underclocked_(underunderclocked_mix).mp3","music/03_Chibi_Ninja.mp3"],c=-1,d=null,e=function(){c=-1==c?Math.randomRange(0,b.length-1,!0):(c+1)%b.length,d.get(0).pause(),d.empty().append($("<source>").attr("src",b[c]).attr("type","audio/mpeg")),d.get(0).play()};d=$("<audio></audio").bind("ended",function(){e()});var f=a.options.music.mute;Object.defineProperty(a.options.music,"mute",{get:function(){return d.get(0).muted},set:function(a){d.get(0).muted=a}}),a.options.music.mute=f;var g=a.options.music.volume;return Object.defineProperty(a.options.music,"volume",{get:function(){return d.get(0).volume},set:function(a){a=Math.max(0,Math.min(1,a)),d.get(0).volume=a}}),a.options.music.volume=g,e(),{nexttrack:e}}(),sfx:function(){var b={change:"sfx/change.mp3",crash:"sfx/crash.mp3"},c={},d=function(a){var b=c[a].get(0);b.play()};$.each(b,function(a,b){var d=$("<audio></audio>").append($("<source>").attr("src",b).attr("type","audio/mpeg"));d.get(0).volume=0,c[a]=d});var e=a.options.sfx.mute;Object.defineProperty(a.options.sfx,"mute",{get:function(){return c.length>=1?c[0].get(0).muted:!1},set:function(a){$.each(c,function(b,c){c.get(0).muted=a})}}),a.options.sfx.mute=e;var f=a.options.sfx.volume;return Object.defineProperty(a.options.sfx,"volume",{get:function(){return c.length>=1?c[0].get(0).volume:.5},set:function(a){a=Math.max(0,Math.min(1,a)),$.each(c,function(b,c){c.get(0).volume=a})}}),a.options.sfx.volume=f,{play:d}}()},c={post:function(a,b){var c="https://docs.google.com/forms/d/1O4OfBssi1MZZd1v7gfo_bsyU_r52IVSN8GEYH1I2Luo/formResponse";$.post(c,{"entry.1065023134":a,"entry.1650551768":b})},get:function(a){var b="1bWUyCx4cLJn6EXe_0Y8NxJ3iJhjqMM5pHfSCEuVD8Ec";$.ajax({url:"https://docs.google.com/spreadsheets/d/"+b+"/gviz/tq?",dataType:"jsonp",type:"GET",cache:!1,data:{tq:"select B, C order by C desc",tqx:"responseHandler:success"},success:function(b){var c=[];$.each(b.table.rows,function(a,b){c.push({name:b.c[0].v,score:b.c[1].v})}),a(c)},jsonpCallback:"success"})}},d=function(){var b={command:{up:{fn:function(){},pressed:!1},down:{fn:function(){},pressed:!1},left:{fn:function(){},pressed:!1},right:{fn:function(){},pressed:!1},enter:{fn:function(){},pressed:!1},back:{fn:function(){},pressed:!1}},gamepad:{buttons:[],axes:[],timestamp:0},orientation:{beta:null,gamma:null},set:{active:!1,key:"",abort:{device:"keyboard",type:null,code:27},callback:null}},c=function(a){a=b.command[a];var c=function(b){a.fn=b};return{call:a.fn,set:c,pressed:a.pressed}},d=function(c){var d=!0;return b.set.active?(b.set.abort.device!=c.device||b.set.abort.type!=c.type||b.set.abort.code!=c.code?(a.options.controls[b.set.key].device=c.device,a.options.controls[b.set.key].type=c.type,a.options.controls[b.set.key].code=c.code,a.save(),b.set.callback(c)):b.set.callback(null),b.set.active=!1,d=!1):$.each(a.options.controls,function(a,e){return e.device==c.device&&e.type==c.type&&e.code==c.code?(b.command[a].pressed=!0,b.command[a].fn(),d=!1,!1):void 0}),d},e=function(c){var d=!0;return $.each(a.options.controls,function(a,e){return e.device==c.device&&e.type==c.type&&e.code==c.code?(b.command[a].pressed=!1,d=!1,!1):void 0}),d},f=function(a){if("keyboard"==a.device){var b={37:"Arrow Left",38:"Arrow Up",39:"Arrow Right",40:"Arrow Down",45:"Insert",46:"Delete",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"Caps Lock",27:"Escape",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",186:"Semicolon",187:"Equal",188:"Comma",189:"Dash",190:"Period",191:"Slash",192:"Grave Accent",219:"Open Bracket",220:"Backslash",221:"Close Braket",222:"Single Quote"};return a.code>=48&&a.code<=90?"Keyboard "+String.fromCharCode(a.code).toLowerCase():"Keyboard "+b[a.code]}return"gamepad"==a.device&&"button"==a.type?"Gamepad Button "+a.code:"gamepad"==a.device&&a.type.match(/axes-\d/)?"Gamepad Axes "+a.code:""},g=function(a,c){b.set.key=a,b.set.callback=c,b.set.active=!0},h=function(){var a=this;$.each(b.command,function(b){a.command(b).set(function(){})})},i=function(c){if(void 0==c&&(c=a.options.gamepad.axes_selected),!navigator.getGamepads||!b.gamepad.axes[c])return{x:0,y:0};var d=b.gamepad.axes[c],e=function(a){var b={min:.1,max:.8};return Math.abs(a)<b.min?0:a>b.max?1:a<-b.max?-1:a>0?(a-b.min)/b.max:(a+b.min)/b.max};return d.x=e(d.x),d.y=e(d.y),d},j=function(c){var f=function(a){b.gamepad.timestamp=a.timestamp;for(var c=0;c<=a.axes.length/2-1;c++)b.gamepad.axes[c]={x:a.axes[2*c],y:a.axes[2*c+1]}},g=function(a,b,c,d,e){c>0&&c>a&&b>=c||0>c&&a>c&&c>=b?d():(c>0&&a>=c&&c>b||0>c&&c>=a&&b>c)&&e()};if(navigator.getGamepads){var h=navigator.getGamepads()[0];if(h&&void 0!=h&&h.timestamp!=b.gamepad.timestamp)if(c){$.each(h.buttons,function(a,c){!b.gamepad.buttons[a]&&c.pressed?(d({device:"gamepad",type:"button",code:a}),c.pressed=!1):b.gamepad.buttons[a]&&!c.pressed&&(e({device:"gamepad",type:"button",code:a}),c.pressed=!0)});for(var i=0;i<=b.gamepad.axes.length-1;i++){var j=b.gamepad.axes[i],k={x:h.axes[2*i],y:h.axes[2*i+1]},l=.5;g(j.y,k.y,l,function(){d({device:"gamepad",type:"axes-"+i,code:"0"})},function(){e({device:"gamepad",type:"axes-"+i,code:"0"})}),g(j.y,k.y,-l,function(){d({device:"gamepad",type:"axes-"+i,code:"1"})},function(){e({device:"gamepad",type:"axes-"+i,code:"1"})}),g(j.x,k.x,l,function(){d({device:"gamepad",type:"axes-"+i,code:"2"})},function(){e({device:"gamepad",type:"axes-"+i,code:"2"})}),g(j.x,k.x,-l,function(){d({device:"gamepad",type:"axes-"+i,code:"3"})},function(){e({device:"gamepad",type:"axes-"+i,code:"3"})})}f(h)}else $.each(a.options.controls,function(a,c){if($.extend(c,b.command[a]),"gamepad"==c.device){var f=function(){d(c)},i=function(){e(c)};if("button"==c.type)c.pressed!=h.buttons[c.code].pressed&&(c.pressed?i():f());else if(c.type.match(/axes-\d/)){var j=/axes-(\d)/.exec(c.type)[1];if(b.gamepad.axes[j]){var k,l,m=c.code%2==0?.5:-.5;2==c.code||3==c.code?(l=b.gamepad.axes[j].x,k=h.axes[2*j]):(l=b.gamepad.axes[j].y,k=h.axes[2*j+1]),g(l,k,m,f,i)}}}}),f(h)}},k=function(){if(!window.DeviceOrientationEvent)return{x:0,y:0};var a;a=b.orientation.gamma/30,a=Math.min(1,a),a=Math.max(-1,a);var c;return c=b.orientation.beta/30,c=Math.min(1,c),c=Math.max(-1,c),{x:a,y:c}},l=function(){var a={x:0,y:0};return a=i(),0==a.x&&0==a.y&&(a=k()),a};return $(document).keydown(function(a){return d({device:"keyboard",type:null,code:a.keyCode})?!0:(a.preventDefault(),!1)}),$(document).keyup(function(a){return e({device:"keyboard",type:null,code:a.keyCode})?!0:(a.preventDefault(),!1)}),!navigator.getGamepads&&navigator.webkitGamepads&&(navigator.getGamepads=navigator.webkitGamepads),j(!0),window.DeviceOrientationEvent&&window.addEventListener("deviceorientation",function(a){b.orientation.beta=a.beta,b.orientation.gamma=a.gamma},!0),{command:c,format:f,ondown:d,onup:e,reset:h,set:g,axes:l,gamepad:{axes:i,axes_length:function(){return b.gamepad.axes.length},poll:j,available:!!navigator.getGamepads},orientation:{axes:k,available:!!window.DeviceOrientationEvent}}}(),e=function(){var g={menu:function(){var c=$("div#menu",a.container);$("span",c).hover(function(){$(this).siblings().removeClass("selected"),$(this).addClass("selected")}),$("span",c).click(function(){e.show($(this).attr("data-screen")),b.sfx.play("change")});var f=function(){},g=function(){d.command("enter").set(function(){$("span.selected",c).click()}),d.command("up").set(function(){var a=$("span.selected",c);a.removeClass("selected"),a.prevAll("span").length>0?a.prev("span").addClass("selected"):a.parent().children("span").last().addClass("selected"),b.sfx.play("change")}),d.command("down").set(function(){var a=$("span.selected",c);a.removeClass("selected"),a.nextAll("span").length>0?a.next("span").addClass("selected"):a.parent().children("span").first().addClass("selected"),b.sfx.play("change")})},h=function(){d.gamepad.poll(!1)};return{container:c,showBefore:f,showAfter:g,loop:h}}(),gameplay:function(){var b=$("div#gameplay",a.container),c=function(){d.command("back").set(function(){f.pause()}),a.container.click(function(){f.pause()}),f.init()},e=function(){f.start()},g=function(){d.gamepad.poll(!1)};return{container:b,showBefore:c,showAfter:e,loop:g}}(),leaderboard:function(){var f=$("div#leaderboard",a.container);$("span.back",f).click(function(){e.show("menu"),b.sfx.play("change")});var g=function(){$("table",f).empty().append($("<tr></tr>").addClass("loading").append($("<td></td>").attr("colspan",3).html("Loading..."))),c.get(function(a){var c=0,d=10,e=$("table",f),g=function(){e.empty();var b=a.slice(c,c+d);$.each(b,function(a,b){$("<tr></tr>").appendTo(e).append($("<td></td>").html(c+a+1)).append($("<td></td>").html(b.name)).append($("<td></td>").html(b.score))}),0==c?$("div span:first-child",f).hide():$("div span:first-child",f).show(),a.length<=c+d?$("div span:last-child",f).hide():$("div span:last-child",f).show()};$("div span:first-child",f).unbind("click").click(function(){c-=d,g(),b.sfx.play("change")}),$("div span:last-child",f).unbind("click").click(function(){c+=d,g(),b.sfx.play("change")}),g()})},h=function(){d.command("back").set(function(){e.show("menu"),b.sfx.play("change")}),d.command("up").set(function(){$("div span:first-child",f).is(":visible")&&$("div span:first-child",f).click()}),d.command("down").set(function(){$("div span:last-child",f).is(":visible")&&$("div span:last-child",f).click()}),d.command("left").set(function(){$("div span:first-child",f).is(":visible")&&$("div span:first-child",f).click()}),d.command("right").set(function(){$("div span:last-child",f).is(":visible")&&$("div span:last-child",f).click()})},i=function(){d.gamepad.poll(!1)};return{container:f,showBefore:g,showAfter:h,loop:i}}(),"gameplay-gameover":function(){var f=$("div#gameplay-gameover",a.container);$("table",f).delegate("td","mouseover",function(){$("table tr td",f).removeClass("selected"),$(this).addClass("selected"),b.sfx.play("change")}),$("table",f).delegate("td","click",function(){var d=$("input[type=text]",f);switch($(this).attr("data-action")){case"add":d.prop("maxlength")>d.val().length&&d.val(d.val()+$(this).attr("data-symbol"+("true"==$("td[data-action=shift]",f).attr("data-pressed")?"1":"2")));break;case"shift":var g=$(this).attr("data-pressed");g="true"==g?"false":"true",$(this).attr("data-pressed",g);var h=$("table tr td[data-action=add]",f);$.each(h,function(a,b){b=$(b),b.html("true"==g?b.html().toUpperCase():b.html().toLowerCase())});break;case"delete":d.val(d.val().slice(0,-1));break;case"cancel":e.show("gameplay-restart");break;case"submit":c.post(d.val(),$("span.score",f).html()),a.options.name=d.val(),a.save(),e.show("gameplay-restart")}b.sfx.play("change")});var g=function(b){$("span.score",f).html(b),$("input[type=text]",f).val(a.options.name)},h=function(){d.command("up").set(function(){var a=$("table tr td.selected",f);if(a.parent().prevAll().length>0){var c=1;$.each(a.prevAll(),function(a,b){c+=$(b).prop("colspan")}),a.removeClass("selected");for(var d=a.parent().prev().children().first();c>0;){var e=d.prop("colspan");c>d.prop("colspan")&&(d=d.next()),c-=e}d.addClass("selected"),b.sfx.play("change")}}),d.command("down").set(function(){var a=$("table tr td.selected",f);if(a.parent().nextAll().length>0){var c=1;$.each(a.prevAll(),function(a,b){c+=$(b).prop("colspan")}),a.removeClass("selected");for(var d=a.parent().next().children().first();c>0;){var e=d.prop("colspan");c>d.prop("colspan")&&(d=d.next()),c-=e}d.addClass("selected"),b.sfx.play("change")}}),d.command("left").set(function(){var a=$("table tr td.selected",f);a.prevAll().length>0&&(a.removeClass("selected"),a.prev().addClass("selected"),b.sfx.play("change"))}),d.command("right").set(function(){var a=$("table tr td.selected",f);a.nextAll().length>0&&(a.removeClass("selected"),a.next().addClass("selected"),b.sfx.play("change"))}),d.command("enter").set(function(){$("table tr td.selected",f).click()}),d.command("back").set(function(){var a=$("input[type=text]",f);a.val(a.val().slice(0,-1))})},i=function(){d.gamepad.poll(!1)};return{container:f,showBefore:g,showAfter:h,loop:i}}(),"gameplay-restart":function(){var c=$("div#gameplay-restart",a.container);$("div span:nth-child(1)",c).click(function(){e.show("gameplay"),b.sfx.play("change")}),$("div span:nth-child(2)",c).click(function(){e.show("menu"),b.sfx.play("change")}),$("div span",c).hover(function(){$(this).siblings().removeClass("selected"),$(this).addClass("selected")});var f=function(){},g=function(){d.command("left").set(function(){$("div span:nth-child(1)",c).hasClass("selected")||($("div span:nth-child(1)",c).addClass("selected"),$("div span:nth-child(2)",c).removeClass("selected"),b.sfx.play("change"))}),d.command("right").set(function(){$("div span:nth-child(2)",c).hasClass("selected")||($("div span:nth-child(1)",c).removeClass("selected"),$("div span:nth-child(2)",c).addClass("selected"),b.sfx.play("change"))}),d.command("enter").set(function(){$("div span.selected",c).click()})},h=function(){d.gamepad.poll(!1)};return{container:c,showBefore:f,showAfter:g,loop:h}}(),controls:function(){var c=$("div#controls",a.container);$("table tr",c).hover(function(){$(this).siblings().removeClass("selected"),$(this).addClass("selected")}),d.gamepad.available||$("table tr[data-control=gamepad]",c).hide(),d.orientation.available||$("table tr[data-control=orientation]",c).hide(),$("span.back",c).click(function(){e.show("menu"),b.sfx.play("change")}),$("table tr[data-control=command]",c).click(function(){if(!$(this).hasClass("disabled")){$("tr",c).addClass("disabled");var a=$("td:nth-child(2)",this),e=a.html();a.html("Please press a key... Esc to cancel"),d.set($(this).attr("data-command"),function(f){a.html(null!=f?d.format(f):e),$("tr",c).removeClass("disabled"),b.sfx.play("change")}),b.sfx.play("change")}});var f=function(){d.gamepad.poll(!0),$.each($("tr[data-command]",c),function(){$("td:nth-child(2)",this).html(d.format(a.options.controls[$(this).attr("data-command")]))}),$("table tr",c).removeClass("selected"),$("table tr:nth-child(1)",c).addClass("selected")},g=function(){d.command("back").set(function(){e.show("menu"),b.sfx.play("change")}),d.command("up").set(function(){var a=$("table tr.selected",c);a.prevAll().length>0&&a.prev().is(":visible")&&(a.removeClass("selected"),a.prev().addClass("selected"),b.sfx.play("change"))}),d.command("down").set(function(){var a=$("table tr.selected",c);a.nextAll().length>0&&a.next().is(":visible")&&(a.removeClass("selected"),a.next().addClass("selected"),b.sfx.play("change"))}),d.command("enter").set(function(){var a=$("table tr.selected",c);if("command"==a.attr("data-control"))a.click();else if("gamepad"==a.attr("data-control")){var b=$("td:nth-child(2) label input[type=radio]:checked",a);b.parent().nextAll().length>0?$("input[type=radio]",b.parent().next()).prop("checked",!0):$("input[type=radio]",b.parent().prevAll().last()).prop("checked",!0)}})},h=function(){if(d.gamepad.available)if(d.gamepad.poll(!0),d.gamepad.axes_length()!=$("tr[data-control=gamepad] td:nth-child(2) label",c).length){$("tr[data-control=gamepad] td:nth-child(2)",c).html("");for(var b=0;b<=d.gamepad.axes_length()-1;b++){var e=d.gamepad.axes(b);$("tr[data-control=gamepad] td:nth-child(2)",c).append($("<label></label>").append($("<input>").attr("type","radio").attr("name","controls-gamepad-move").change(function(){a.options.gamepad.axes_selected=$(this).parent().parent().prevAll().length,a.save()})).append($("<progress></progress>").attr("min",0).attr("max",2).val(e.x+1)).append($("<progress></progress>").attr("min",0).attr("max",2).val(e.y+1)))}a.options.gamepad.axes_selected>d.gamepad.axes_length()-1&&(a.options.gamepad.axes_selected=0),$("tr[data-control=gamepad] td:nth-child(2) label:nth-child("+(a.options.gamepad.axes_selected+1)+") input[type=radio]",c).prop("checked",!0)}else for(var b=0;b<=d.gamepad.axes_length()-1;b++){var e=d.gamepad.axes(b);$("tr[data-control=gamepad] td:nth-child(2) label:nth-child("+(b+1)+") progress:nth-child(2)",c).val(e.x+1),$("tr[data-control=gamepad] td:nth-child(2) label:nth-child("+(b+1)+") progress:nth-child(3)",c).val(e.y+1)}d.orientation.available&&($("progress[data-control=orientation]:nth-child(1)",c).val(30*d.orientation.axes().x+30),$("progress[data-control=orientation]:nth-child(2)",c).val(30*d.orientation.axes().y+30))};return{container:c,showBefore:f,showAfter:g,loop:h}}(),options:function(){var c=$("div#options",a.container);$("tbody tr",c).hover(function(){$(this).siblings().removeClass("selected"),$(this).addClass("selected")}),$("input",c).on("change mousemove",function(){a.options.style=$("input[data-option=style]:checked",c).val(),a.options.music.mute=$("input[data-option=music-mute]",c).prop("checked"),a.options.music.volume=$("input[data-option=music-volume]",c).val(),a.options.sfx.mute=$("input[data-option=sfx-mute]",c).prop("checked"),a.options.sfx.volume=$("input[data-option=sfx-volume]",c).val(),a.options.speed=$("input[data-option=speed]",c).val(),a.save()}),$("input[data-option=fullscreen]",c).change(function(){$("input[data-option=fullscreen]",c).prop("checked")?(screenfull.enabled&&screenfull.request(),a.container.addClass("fullscreen")):(screenfull.enabled&&screenfull.exit(),a.container.removeClass("fullscreen"))}),$("span.back",c).click(function(){e.show("menu"),b.sfx.play("change")}),$("img",c).click(function(){$(this).prev("input").prop("checked")||b.sfx.play("change")}),$("input[type=checkbox]",c).click(function(){b.sfx.play("change")});var f=function(){$("input[value="+a.options.style+"]",c).prop("checked",!0),$("input[data-option=music-mute]",c).prop("checked",a.options.music.mute),$("input[data-option=music-volume]",c).val(a.options.music.volume),$("input[data-option=sfx-mute]",c).prop("checked",a.options.sfx.mute),$("input[data-option=sfx-volume]",c).val(a.options.sfx.volume),$("input[data-option=speed]",c).val(a.options.speed)},g=function(){d.command("back").set(function(){e.show("menu"),b.sfx.play("change")}),d.command("enter").set(function(){var a=$("table tr.selected input[type=checkbox]",c);1==a.length&&a.prop("checked",!a.prop("checked")).trigger("change")}),d.command("up").set(function(){var a=$("table tr.selected",c);a.prevAll().length>0&&(a.removeClass("selected"),a.prev().addClass("selected"),b.sfx.play("change"))}),d.command("down").set(function(){var a=$("table tr.selected",c);a.nextAll().length>0&&(a.removeClass("selected"),a.next().addClass("selected"),b.sfx.play("change"))}),d.command("left").set(function(){var a=$("table tr.selected",c),d=$("input[type=radio]:checked",a);1==d.length&&1==d.parent("label").prev().length&&(d.prop("checked",!1),d.parent("label").prev().children("input[type=radio]").prop("checked",!0).trigger("change"),b.sfx.play("change"));var e=$("input[type=range]",a);if(1==e.length){var f=1;e.attr("step")&&(f=parseFloat(e.attr("step"))),e.val(parseFloat(e.val())-f).trigger("change"),b.sfx.play("change")}}),d.command("right").set(function(){var a=$("table tr.selected",c),d=$("input[type=radio]:checked",a);1==d.length&&1==d.parent("label").next().length&&(d.prop("checked",!1),d.parent("label").next().children("input[type=radio]").prop("checked",!0).trigger("change"),b.sfx.play("change"));var e=$("input[type=range]",a);if(1==e.length){var f=1;e.attr("step")&&(f=parseFloat(e.attr("step"))),e.val(parseFloat(e.val())+f).trigger("change"),b.sfx.play("change")}})},h=function(){d.gamepad.poll(!1)};return{container:c,showBefore:f,showAfter:g,loop:h}}(),about:function(){var c=$("div#about",a.container);$("span.back",c).click(function(){e.show("menu"),b.sfx.play("change")});var f=function(){},g=function(){d.command("back").set(function(){e.show("menu"),b.sfx.play("change")})},h=function(){d.gamepad.poll(!1)};return{container:c,showBefore:f,showAfter:g,loop:h}}()},h=function(a,b){var c=function(){if(a.loop){var c=function(){var b=a.loop();void 0==b&&(b=!0),a.container.is(":visible")&&b&&window.requestAnimationFrame(c)};window.setTimeout(function(){window.requestAnimationFrame(c)},500)}a.showAfter(b)};d.reset(),a=g[a],a.showBefore(b),a.container.siblings(":visible").length>0?a.container.siblings(":visible").fadeOut(250,function(){a.container.fadeIn(250,c)}):(a.container.show(),c())};return h("menu"),{show:h}}(),f={game:null,init:function(){var c=$("div#gameplay",a.container);c.html(""),this.game=new Playground({container:c.get(0),width:480,height:432,background:{x:0,y:0,img:null,src:"",width:0,height:0},character:{x:0,y:0,img:null,src:"",width:48,height:48},obstacle:{items:[{img:null,src:"",src_suffix:"-1x1",spawnprobability:5,create:function(a){return{img:this.img,x:Math.randomRange(0,a.width-50,!0),y:-50,width:50,height:50,spawntime:a.time,game:a,calc:function(b){this.y+=b*a.obstacle.speed*a.getSpeedFactor()}}}},{img:null,src:"",src_suffix:"-1x2",spawnprobability:4,create:function(a){return{img:this.img,x:Math.randomRange(0,a.width-50,!0),y:-100,width:50,height:100,spawntime:a.time,game:a,calc:function(b){this.y+=b*a.obstacle.speed*a.getSpeedFactor()}}}},{img:null,src:"",src_suffix:"-2x1",spawnprobability:4,create:function(a){return{img:this.img,x:Math.randomRange(0,a.width-100,!0),y:-50,width:100,height:50,spawntime:a.time,game:a,calc:function(b){this.y+=b*a.obstacle.speed*a.getSpeedFactor()}}}},{img:null,src:"",src_suffix:"-1x1",spawnprobability:2,create:function(a){return{img:this.img,x:Math.randomRange(0,a.width-50,!0),y:-50,width:50,height:50,spawntime:a.time,game:a,calc:function(b){this.y+=b*a.obstacle.speed*a.getSpeedFactor()*2}}}},{img:null,src:"",src_suffix:"-1x1",spawnprobability:1,create:function(a){var b=150,c=Math.randomRange(b/2,a.width-50-b/2,!0);return{img:this.img,x:c,x_org:c,y:-50,width:50,height:50,spawntime:a.time,game:a,calc:function(c){this.x=this.x_org+Math.sin(4*(this.spawntime-a.time))*b/2,this.y+=c*a.obstacle.speed*a.getSpeedFactor()}}}}],next:{time:0,min:.5,max:2.5,calc:function(a){this.time=a+Math.randomRange(this.min,this.max)}},speed:100,speed_time:10,speed_factor:1.15},obstacles:[],states:{create:0,countdown:1,running:2,pause:3,gameover:4},state:0,prepared:!1,time:0,score:0,points:{time:10,obstacle:.005},create:function(){this.prepared=!1,this.background.src=a.options.style+"/background",this.loadImages(this.background.src+".jpg"),this.character.src=a.options.style+"/character",this.loadImages(this.character.src);var b=this;$.each(this.obstacle.items,function(c,d){b.loadImages(a.options.style+"/obstacle"+d.src_suffix),d.src=a.options.style+"/obstacle"+d.src_suffix}),this.obstacle.next.calc(0),this.obstacles=[],this.time=-3,this.score=0},step:function(b){var c=this;if(!this.prepared){if(null==this.background.img){this.background.img=this.images[this.background.src];var e=this.width/this.background.img.naturalWidth;this.background.width=Math.round(this.background.img.naturalWidth*e),this.background.height=Math.round(this.background.img.naturalHeight*e)}null==this.character.img&&(this.character.img=this.images[this.character.src],this.character.x=(this.width-this.character.width)/2,this.character.y=this.height-this.character.height),$.each(this.obstacle.items,function(a,b){b.img=c.images[b.src]}),this.prepared=!0}if(this.state==this.states.countdown)this.prepared&&(this.time+=b,this.time>=0&&(this.state=this.states.running));else if(this.state==this.states.running){this.time+=b,this.score+=b*this.points.time,this.background.y=(this.background.y+this.obstacle.speed*b*c.getSpeedFactor())%this.background.height,d.gamepad.poll(!1);var f=0,g=0;if(f=d.axes().x,g=d.axes().y,0==f&&(d.command("left").pressed&&!d.command("right").pressed?f=-1:!d.command("left").pressed&&d.command("right").pressed&&(f=1)),0==g&&(d.command("up").pressed&&!d.command("down").pressed?g=-1:!d.command("up").pressed&&d.command("down").pressed&&(g=1)),this.character.x+=f*a.options.speed*b,this.character.x=Math.max(this.character.x,0),this.character.x=Math.min(this.character.x,this.width-this.character.width),this.character.y+=g*a.options.speed*b,this.character.y=Math.max(this.character.y,0),this.character.y=Math.min(this.character.y,this.height-this.character.height),this.time>=this.obstacle.next.time){var h=this.obstacle.items.reduce(function(a,b){return a.push(b.spawnprobability),a},[]),i=Math.randomWeighted(h);this.obstacles.push(this.obstacle.items[i].create(this)),this.obstacle.next.calc(this.time)}$.each(this.obstacles,function(a,d){d.calc(b),c.character.x<d.x+d.width&&c.character.x+c.character.width>d.x&&c.character.y<d.y+d.height&&c.character.height+c.character.y>d.y&&c.collision()}),this.obstacles=$.grep(this.obstacles,function(a){var b=a.y>=c.height;return b&&(c.score+=c.points.obstacle*a.width*a.height),!b})}},render:function(){var a=this;this.layer.clear("#FFFFFF");for(var b=this.background.y-this.background.height;b<this.height;)this.layer.drawImage(this.background.img,this.background.x,b,this.background.width,this.background.height),b+=this.background.height-1;if(this.layer.drawImage(this.character.img,this.character.x,this.character.y,this.character.width,this.character.height),$.each(this.obstacles,function(b,c){a.layer.drawImage(c.img,c.x,c.y,c.width,c.height)}),this.layer.fillStyle("#FFFFFF").font("16px Arial").wrappedText("Time:  "+Math.floor(this.time).toString()+"s",5,16).wrappedText("Score: "+Math.floor(this.score).toString(),5,40),this.state==this.states.countdown){this.layer.font("200px Arial");var c=Math.abs(Math.floor(this.time)).toString();textboundaries=this.layer.textBoundaries(c),this.layer.fillStyle("#FFFFFF").wrappedText(c,(this.width-textboundaries.width)/2,(this.height+textboundaries.height)/2)}if(this.state==this.states.pause){this.layer.font("100px Arial");var c="Pause";textboundaries=this.layer.textBoundaries(c),this.layer.fillStyle("#FFFFFF").wrappedText(c,(this.width-textboundaries.width)/2,(this.height+textboundaries.height)/2)}},collision:function(){this.state=this.states.gameover,$(this.container).html(""),b.sfx.play("crash"),e.show("gameplay-gameover",Math.floor(this.score))},getSpeedFactor:function(){return Math.pow(this.obstacle.speed_factor,Math.floor(this.time/this.obstacle.speed_time))}})},start:function(){this.game.state=this.game.states.countdown},pause:function(){this.game.state==this.game.states.running?(this.game.state=this.game.states.pause,b.sfx.play("change")):this.game.state==this.game.states.pause&&(this.game.state=this.game.states.running,b.sfx.play("change"))}}});